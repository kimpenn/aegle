# Top-level configuration for CODEX pipeline
exp_id: D11_0
sample_id: 11-64

# -----------------------------------------------------------------------------
# (A) Data Source and Basic Image Settings
# -----------------------------------------------------------------------------
data:
  # Path to the main .qptiff or .tiff file for the CODEX image
  file_name: 
    /workspaces/codex-analysis/data/FallopianTube/D11/img0005/processed_hubmap/img0005_manual_11-64_FT_Ampulla_Scan1.ome.tiff

  # Path to the TSV file containing antibody definitions (one row per channel)
  antibodies_file: 
    /workspaces/codex-analysis/data/FallopianTube/D11/img0005/extras/antibodies.tsv

  # Microns per pixel for this image; used in downstream calculations (e.g., segmentation scaling)
  image_mpp: 0.5

  # Whether to compute and save channel-level statistics (min, max, 95th percentile, etc.)
  generate_channel_stats: false

# -----------------------------------------------------------------------------
# (B) Channel Configuration
# -----------------------------------------------------------------------------
channels:
  # Name of the nuclear marker channel (must match an entry in the antibodies file)
  nuclear_channel: DAPI

  # Name(s) of the whole-cell marker channel(s). If multiple, they will be merged.
  wholecell_channel:
    - Pan-Cytokeratin
    - E-cadherin
    - Beta-actin
    - FUT4
    - SMA
patching:
  # Split mode can be "full_image", "halves", "quarters", or "patches"
  split_mode: full_image

  # Split direction can be "vertical" or "horizontal"
  split_direction: NULL

  # Size (height, width) of each patch (in pixels)
  patch_height: NULL
  patch_width: NULL

  # Overlap fraction between adjacent patches (0.1 means 10% overlap)
  overlap: NULL

# -----------------------------------------------------------------------------
# (D) Visualization Settings
# -----------------------------------------------------------------------------
visualization:
  # Whether to save RGB visualizations of all patches
  visualize_patches: true

  # Whether to keep a temporary compressed cache of the full multi-channel patches for reuse
  cache_all_channel_patches: true

  # Whether to save the raw multi-channel patches to disk at the end of the run
  save_all_channel_patches: false

  # Number of threads to use when compressing all-channel patches (0=auto, -1=all cores)
  all_channel_compression_threads: 120

  # Whether to visualize and save the segmentation mask overlay (after segmentation)
  visualize_segmentation: true

# -----------------------------------------------------------------------------
# (E) QC (Patch-Level Quality Control)
# -----------------------------------------------------------------------------
patch_qc:
  # Minimum fraction of non-zero pixels required for a patch to be considered valid
  non_zero_perc_threshold: 0.05

  # Minimum mean intensity for the patch to be considered informative
  mean_intensity_threshold: 1.0

  # Minimum standard deviation required to avoid marking patches as too "flat"
  std_intensity_threshold: 1.0

# -----------------------------------------------------------------------------
# (F) Segmentation Parameters and Output Options
# -----------------------------------------------------------------------------
segmentation:
  # Path to the segmentation model directory (e.g., for DeepCell or another tool)
  model_path: /workspaces/codex-analysis/data/deepcell/v7/MultiplexSegmentation

  # If True, save segmentation masks as images
  save_segmentation_images: true

  # If True, pickle the entire codex_patches object (containing segmentation results, etc.)
  save_segmentation_pickle: true
  segmentation_pickle_compression: zstd      # options: none|gzip|bz2|lzma|zstd
  segmentation_pickle_compression_level: 5   # optional, honours backend limits
  segmentation_pickle_compression_threads: 0   # 0=auto, -1=all cores
  # If True, run segmentation analysis
  # Calculate metrics based on the segmentation results to describe the data quality
  segmentation_analysis: false
  density_analysis:
    calculate_global_density: false
    calculate_local_density: false

  # GPU-accelerated mask repair (Phases 2, 3, 4, 5c)
  repair:
    # Enable GPU acceleration for mask repair operations
    # Provides 3-6x speedup for overlap (Phase 4), 400-540x for bincount (Phase 5c)
    # Requires CuPy and CUDA-compatible GPU. Falls back to CPU if GPU unavailable.
    use_gpu: true

    # Phase 5c: Use bincount approach for overlap computation (400-540x speedup)
    # When True: tries bincount first, falls back to Phase 4 if needed
    # Recommended: True for samples with >100K cells
    use_bincount_overlap: true

    # Batch size for GPU overlap/mismatch computation (null = auto-size)
    gpu_batch_size: null
    gpu_mismatch_batch_size: null

    # Number of GPUs to use for mismatch computation (default: 1, 2=1.87x speedup)
    # Set to 2 to distribute Stage 4 batches across 2 GPUs in parallel
    # Saves ~6 min per sample on large datasets (>150K overlapping pairs)
    mismatch_num_gpus: 2

    # Automatically fallback to CPU if GPU errors occur
    fallback_to_cpu: true

    # Log detailed GPU performance metrics
    log_gpu_performance: true

# -----------------------------------------------------------------------------
# (F.1) Cell Profiling Optimization
# -----------------------------------------------------------------------------
profiling:
  features:
    # Disable expensive features (unless scientifically required)
    compute_laplacian: false  # Skip expensive Laplacian variance calculation
    compute_cov: false         # Skip coefficient of variation calculation

    # Use float32 for 2x memory reduction (vs float64)
    channel_dtype: float32

    # Enable GPU acceleration for cell profiling (20-50x speedup for large samples)
    # Requires CuPy and CUDA-compatible GPU. Falls back to CPU if GPU unavailable.
    use_gpu: true

    # GPU batch size (number of channels to process at once on GPU)
    # Set to 0 for automatic detection based on available VRAM
    gpu_batch_size: 0

# -----------------------------------------------------------------------------
# (G) Testing Data Disruption (Optional) 
#     If you do not want to disrupt your data, set "type" to null or remove this block.
# -----------------------------------------------------------------------------
testing:
  data_disruption:
    # Disruption type can be "downsampling" or "gaussian"
    type: NULL

    # Intensity level of disruption (1-5, for instance)
    level: NULL

    # Whether to save the disrupted patches to disk (for debugging/testing)
    save_disrupted_patches: NULL

    # Whether to visualize the disrupted patches
    visualize_disrupted: false

# -----------------------------------------------------------------------------
# (H) Evaluation Metrics
# -----------------------------------------------------------------------------
evaluation:
  compute_metrics: false
report:
  generate_report: true
  report_format: html
