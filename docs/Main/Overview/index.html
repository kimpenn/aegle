<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Main/Overview" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Overview | Aegle: PhenoCycler Pipeline @ PennTMC</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kimpenn.github.io/aegle/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kimpenn.github.io/aegle/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kimpenn.github.io/aegle/docs/Main/Overview"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Overview | Aegle: PhenoCycler Pipeline @ PennTMC"><meta data-rh="true" name="description" content="This document provides detailed information about the core components of the Main analysis pipeline. The pipeline transforms raw multiplex imaging data into quantified single-cell profiles through a series of carefully orchestrated processing stages."><meta data-rh="true" property="og:description" content="This document provides detailed information about the core components of the Main analysis pipeline. The pipeline transforms raw multiplex imaging data into quantified single-cell profiles through a series of carefully orchestrated processing stages."><link data-rh="true" rel="icon" href="/aegle/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kimpenn.github.io/aegle/docs/Main/Overview"><link data-rh="true" rel="alternate" href="https://kimpenn.github.io/aegle/docs/Main/Overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://kimpenn.github.io/aegle/docs/Main/Overview" hreflang="x-default"><link rel="stylesheet" href="/aegle/assets/css/styles.de497946.css">
<script src="/aegle/assets/js/runtime~main.33afe438.js" defer="defer"></script>
<script src="/aegle/assets/js/main.fb9f3ee6.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/aegle/img/aegle_icon.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/aegle/"><div class="navbar__logo"><img src="/aegle/img/aegle_icon.svg" alt="Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/aegle/img/aegle_icon.svg" alt="Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Aegle</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/aegle/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kimpenn/aegle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aegle/docs/intro">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aegle/docs/category/setup">Setup</a><button aria-label="Expand sidebar category &#x27;Setup&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aegle/docs/category/experiment-configuration">Experiment Configuration</a><button aria-label="Expand sidebar category &#x27;Experiment Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aegle/docs/category/data-preprocessing">Data Preprocessing</a><button aria-label="Expand sidebar category &#x27;Data Preprocessing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/aegle/docs/category/main-processing">Main Processing</a><button aria-label="Collapse sidebar category &#x27;Main Processing&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/aegle/docs/Main/Overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aegle/docs/Main/UsageGuide">Usage Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aegle/docs/Main/Outputs">Outputs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aegle/docs/Main/Configuration">Configuration Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aegle/docs/Main/SegmentationDetails">Segmentation Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aegle/docs/Main/EvaluationDetails">Evaluation Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aegle/docs/Main/SegmentationAnalysis">Segmentation Analysis</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aegle/docs/post_analysis">Post-Analysis Visualization</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aegle/docs/category/single-cell-analysis">Single-cell Analysis</a><button aria-label="Expand sidebar category &#x27;Single-cell Analysis&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/aegle/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/aegle/docs/category/main-processing"><span itemprop="name">Main Processing</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Overview</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Overview</h1></header>
<p>This document provides detailed information about the core components of the Main analysis pipeline. The pipeline transforms raw multiplex imaging data into quantified single-cell profiles through a series of carefully orchestrated processing stages.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pipeline-architecture">Pipeline Architecture<a href="#pipeline-architecture" class="hash-link" aria-label="Direct link to Pipeline Architecture" title="Direct link to Pipeline Architecture">​</a></h2>
<p>The Main pipeline consists of two primary processing phases that work together to extract meaningful biological information from large-scale multiplex imaging data:</p>
<p><img decoding="async" loading="lazy" alt="Aegle Main Pipeline" src="/aegle/assets/images/agle-main.drawio-eb84fce560ed0f6458f188a2c215087d.png" width="1391" height="371" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="output-structure">Output Structure<a href="#output-structure" class="hash-link" aria-label="Direct link to Output Structure" title="Direct link to Output Structure">​</a></h2>
<p>The pipeline generates comprehensive outputs organized in a structured format:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output_directory/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cell_profiling/              # Single-cell data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── patch-0-cell_by_marker.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── patch-0-cell_metadata.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── extracted_channel_patches.npy   # Processed image patches</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── original_seg_res_batch.pickle   # Raw segmentation results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── matched_seg_res_batch.pickle    # Processed segmentation results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── patches_metadata.csv            # Patch-level metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── channel_stats.csv              # Channel statistics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── copied_config.yaml             # Configuration record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── seg_evaluation_metrics.pkl     # Segmentation evaluation results</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-loading-and-preprocessing">Data Loading and Preprocessing<a href="#data-loading-and-preprocessing" class="hash-link" aria-label="Direct link to Data Loading and Preprocessing" title="Direct link to Data Loading and Preprocessing">​</a></h2>
<p>Before segmentation, the pipeline loads the image and the antibodies data and prepare objects for further processing.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="load-image-and-antibodies-data">Load Image and Antibodies Data<a href="#load-image-and-antibodies-data" class="hash-link" aria-label="Direct link to Load Image and Antibodies Data" title="Direct link to Load Image and Antibodies Data">​</a></h3>
<p>This initial phase loads the multiplex image and the antibodies data into the <code>CodexImage</code> object.</p>
<p>Then Calculate channel-level statistics (Min, Median, Max, 95%, Mean, Std Dev) and save them to a file <code>channel_stats.csv</code>.</p>
<p>Next, extract the target channels from the image based on the configuration. If more than one wholecell channel is specified, they will be merged into a single channel by taking the maximum intensity projection. The extracted channels are stacked along the third dimension in the order of (nucleus, wholecell) and assigned to the <code>extracted_channel_image</code> attribute of the <code>CodexImage</code> object.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-based-processing">Patch-Based Processing<a href="#patch-based-processing" class="hash-link" aria-label="Direct link to Patch-Based Processing" title="Direct link to Patch-Based Processing">​</a></h3>
<p>Ideally, we just use <code>patching::split_mode</code> as <code>full_image</code> and consider the image as a single patch for segmentation. However, sometimes the image is too large to be processed in a single patch, we can use <code>patching::split_mode</code> as <code>halves</code> or <code>quarters</code> to divide the image into manageable patches. I had situation that after spliting, the image is still too large to fit into memory. So we implemented a disk-based patches strategy to handle large images. See <code>_extract_patches_from_coordinates</code> in <code>codex_patches.py</code>. But we should implment more unit test to make sure the disk-based patches strategy is working as expected.</p>
<p>On the other hand, we would like to do segmentation on small patches for other purposes, such as patch-level analysis. We can use <code>patching::split_mode</code> as <code>patches</code> to divide the image into small patches. The <code>patching::patch_height</code> and <code>patching::patch_width</code> are the height and width of each patch, and the <code>patching::overlap</code> is the overlap fraction between adjacent patches. We have a <a href="https://github.com/kimpenn/aegle_patch_viewer" target="_blank" rel="noopener noreferrer">web app</a> to visualize the patches with the overlap to have intuition about the patches. Two have patches in same shape, we have two steps:(1) extend the image for full patch coverage and (2) generate the patches on the extended image. The patches are saved in the <code>CodexPatches</code> object as <code>extracted_channel_patches</code> and <code>all_channel_patches</code> attributes.</p>
<p>The metadata of patches are calculated, including patch_id, height, width, nucleus_mean, nucleus_std, nucleus_non_zero_perc, wholecell_mean, wholecell_std, wholecell_non_zero_perc. Config has <code>patch_qc</code> section to control the quality control, including</p>
<ul>
<li><code>non_zero_perc_threshold</code>: Minimum fraction of non-zero pixels required for a patch to be considered valid</li>
<li><code>mean_intensity_threshold</code>: Minimum mean intensity for the patch to be considered informative</li>
<li><code>std_intensity_threshold</code>: Minimum standard deviation required to avoid marking patches as too &quot;flat&quot;
Currently the first two are used. A patch is considered empty if the <code>nucleus_non_zero_perc</code> is less than <code>non_zero_perc_threshold</code> and considered noisy if the <code>nucleus_mean</code> is less than <code>mean_intensity_threshold</code> and it is set as <code>is_empty</code> and <code>is_noisy</code> in <code>patches_metadata</code>. Either of them is true, the patch is marked as bad and set as <code>is_bad_patch</code> in <code>patches_metadata</code>. The patches are marked as informative if they are not bad. Details see <code>qc_patch_metadata</code> in <code>codex_patches.py</code>. It helps to filter out the patches which are background, artifacts, or just a small part of the tissue. We will only run segmentation on the informative patches.</li>
</ul>
<p>The matadata is saved as <code>patches_metadata</code> attribute of the <code>CodexPatches</code> object and saved in the <code>patches_metadata.csv</code> file.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optional-patch-perturbations">Optional Patch Perturbations<a href="#optional-patch-perturbations" class="hash-link" aria-label="Direct link to Optional Patch Perturbations" title="Direct link to Optional Patch Perturbations">​</a></h3>
<p>To test the robustness of downstream segmentation models, we implment this module to add controlled perturbations to the patches. So that we can benchmarking the segmentation models on different types of data disruptions. It should not be used in the production environment.</p>
<ul>
<li>If <code>testing::data_disruption::type</code> is None, no perturbations will be added.</li>
<li>If <code>testing::data_disruption::type</code> is <code>gaussian</code>, we will add Gaussian noise to the patches. The noise level is controlled by <code>testing::data_disruption::level</code>. The noise level is a number between 1 and 5. 1 is the minimal noise level and 5 is the maximal noise level.</li>
<li>If <code>testing::data_disruption::type</code> is <code>downsampling</code>, we will downsample the patches. The downsampling level is controlled by <code>testing::data_disruption::level</code>. The downsampling level is a number between 1 and 3. 1 is the minimal downsampling level and 3 is the maximal downsampling level.</li>
</ul>
<p>We can use <code>testing::data_disruption</code> section to control the perturbations. Details see <code>add_disruptions</code> in <code>codex_patches.py</code>.</p>
<p>TODO: It might be better to isolate this module from the main pipeline. So that we can use it in the production environment. But we need to make more changes and divide the pipeline into more components such that the output from perturbation module can be integrated into the main pipeline.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optional-patch-visualizations">Optional Patch Visualizations<a href="#optional-patch-visualizations" class="hash-link" aria-label="Direct link to Optional Patch Visualizations" title="Direct link to Optional Patch Visualizations">​</a></h3>
<p>We generate the visualizations of the patches to help the user to check the quality of the patches and the perturbations.</p>
<p>Notes: Given <code>visualization::visualize_patches</code> is True, if <code>testing::data_disruption::visualize_disrupted</code> is True, the visualizations will be the disrupted patches. Otherwise, the visualizations will be the original patches.</p>
<p><strong>Visualization Configuration</strong>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">testing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">data_disruption</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Disruption type can be &quot;downsampling&quot; or &quot;gaussian&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gaussian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Intensity level of disruption (1-5, for instance)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">level</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Whether to save the disrupted patches to disk (for debugging/testing)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">save_disrupted_patches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Whether to visualize the disrupted patches</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">visualize_disrupted</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">False</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Outputs</strong>:</p>
<ul>
<li><code>patches_visualizations/good_patches/patch-{i}.png</code></li>
<li><code>patches_visualizations/bad_patches/patch-{i}.png</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="segmentation-and-evaluation">Segmentation and Evaluation<a href="#segmentation-and-evaluation" class="hash-link" aria-label="Direct link to Segmentation and Evaluation" title="Direct link to Segmentation and Evaluation">​</a></h2>
<p>This stage covers both <strong>segmentation</strong> and <strong>automated quality assessment</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cell-segmentation">Cell Segmentation<a href="#cell-segmentation" class="hash-link" aria-label="Direct link to Cell Segmentation" title="Direct link to Cell Segmentation">​</a></h3>
<p>This phase performs cell and nucleus segmentation on the informative patches using the DeepCell Mesmer model. The segmentation process identifies individual cells and their corresponding nuclei, enabling downstream single-cell analysis. The <code>run_cell_segmentation</code> function in <code>segment.py</code> orchestrates the entire segmentation process:</p>
<ol>
<li><strong>Patch Selection</strong>: Only processes patches marked as informative (not empty or noisy) from Phase B</li>
<li><strong>Model Loading</strong>: Loads the pre-trained DeepCell Mesmer model for multiplex segmentation</li>
<li><strong>Segmentation Processing</strong>: Applies the model to extract cell and nucleus masks</li>
<li><strong>Mask Repair</strong>: Matches cells to nuclei and repairs segmentation artifacts</li>
<li><strong>Result Storage</strong>: Saves segmentation masks and metadata</li>
</ol>
<p>More details see <a href="/aegle/docs/Main/SegmentationDetails">Segmentation Details</a>.</p>
<p><strong>Segmentation Configuration</strong>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">segmentation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Path to the DeepCell Mesmer model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">model_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /path/to/MultiplexSegmentation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Save segmentation masks as image files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">save_segmentation_images</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Save complete segmentation results as pickle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">save_segmentation_pickle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Outputs</strong></p>
<ul>
<li>Segmentation Masks (per patch):<!-- -->
<ul>
<li><code>cell_matched_mask</code>: Matched cell segmentation masks</li>
<li><code>nucleus_matched_mask</code>: Matched nucleus segmentation masks</li>
<li><code>cell_outside_nucleus_mask</code>: Cell regions outside nucleus boundaries</li>
</ul>
</li>
<li>Metadata:<!-- -->
<ul>
<li><code>patches_metadata.csv</code>: Updated with <code>matched_fraction</code> for each patch</li>
<li>Segmentation quality statistics and matching metrics</li>
</ul>
</li>
<li>Optional Outputs:<!-- -->
<ul>
<li>Segmentation mask images (if <code>save_segmentation_images: true</code>)</li>
<li>Complete <code>CodexPatches</code> pickle file (if <code>save_segmentation_pickle: true</code>)</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="segmentation-evaluation">Segmentation Evaluation<a href="#segmentation-evaluation" class="hash-link" aria-label="Direct link to Segmentation Evaluation" title="Direct link to Segmentation Evaluation">​</a></h3>
<p>This step is the automated segmentation quality assessment using the <code>run_seg_evaluation</code> function implemented in <code>evaluation.py</code>. This evaluation system provides comprehensive metrics to assess the quality of cell segmentation results. The evaluation process follows these key steps:</p>
<ol>
<li><strong>Patch Filtering</strong>: Only evaluates informative patches (marked as <code>is_informative</code> in metadata)</li>
<li><strong>Cell Count Validation</strong>: Skips patches with fewer than 20 cells to ensure statistical reliability</li>
<li><strong>Parallel Processing</strong>: Uses 2 worker processes for efficient evaluation across multiple patches</li>
<li><strong>Comprehensive Metrics</strong>: Calculates 14 different quality metrics for each patch</li>
<li><strong>Quality Score Generation</strong>: Combines metrics into a single quality score using PCA-based model</li>
</ol>
<p>More details see <a href="/aegle/docs/Main/EvaluationDetails">Evaluation Details</a>.</p>
<p><strong>Evaluation Configuration</strong>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">evaluation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">compute_metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Outputs</strong></p>
<p>The evaluation results are stored in <code>codex_patches.seg_evaluation_metrics</code> as a list of dictionaries, where each dictionary contains and saved in the <code>seg_evaluation_metrics.pkl</code> file.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="post-segmentation-analysis">Post-Segmentation Analysis<a href="#post-segmentation-analysis" class="hash-link" aria-label="Direct link to Post-Segmentation Analysis" title="Direct link to Post-Segmentation Analysis">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cell-profiling">Cell Profiling<a href="#cell-profiling" class="hash-link" aria-label="Direct link to Cell Profiling" title="Direct link to Cell Profiling">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="qc-metrics">QC Metrics<a href="#qc-metrics" class="hash-link" aria-label="Direct link to QC Metrics" title="Direct link to QC Metrics">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="visualizations">Visualizations<a href="#visualizations" class="hash-link" aria-label="Direct link to Visualizations" title="Direct link to Visualizations">​</a></h3></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Main/Overview.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/aegle/docs/category/main-processing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Main Processing</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/aegle/docs/Main/UsageGuide"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Usage Guide</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pipeline-architecture" class="table-of-contents__link toc-highlight">Pipeline Architecture</a></li><li><a href="#output-structure" class="table-of-contents__link toc-highlight">Output Structure</a></li><li><a href="#data-loading-and-preprocessing" class="table-of-contents__link toc-highlight">Data Loading and Preprocessing</a><ul><li><a href="#load-image-and-antibodies-data" class="table-of-contents__link toc-highlight">Load Image and Antibodies Data</a></li><li><a href="#patch-based-processing" class="table-of-contents__link toc-highlight">Patch-Based Processing</a></li><li><a href="#optional-patch-perturbations" class="table-of-contents__link toc-highlight">Optional Patch Perturbations</a></li><li><a href="#optional-patch-visualizations" class="table-of-contents__link toc-highlight">Optional Patch Visualizations</a></li></ul></li><li><a href="#segmentation-and-evaluation" class="table-of-contents__link toc-highlight">Segmentation and Evaluation</a><ul><li><a href="#cell-segmentation" class="table-of-contents__link toc-highlight">Cell Segmentation</a></li><li><a href="#segmentation-evaluation" class="table-of-contents__link toc-highlight">Segmentation Evaluation</a></li></ul></li><li><a href="#post-segmentation-analysis" class="table-of-contents__link toc-highlight">Post-Segmentation Analysis</a><ul><li><a href="#cell-profiling" class="table-of-contents__link toc-highlight">Cell Profiling</a></li><li><a href="#qc-metrics" class="table-of-contents__link toc-highlight">QC Metrics</a></li><li><a href="#visualizations" class="table-of-contents__link toc-highlight">Visualizations</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>